# üîß Documenta√ß√£o de Corre√ß√£o do Deploy - Next.js Standalone

## üìã Resumo Executivo

Este documento explica detalhadamente os problemas encontrados no deployment da aplica√ß√£o Next.js e as solu√ß√µes implementadas para corrig√≠-los definitivamente.

---

## ‚ùå Problemas Identificados

### 1. **Erro Principal: "Cannot find module '/workspace/.next/standalone/server.js'"**

O erro ocorria na fase de execu√ß√£o (runtime), mesmo ap√≥s o build completar com sucesso. Isso indicava que o arquivo estava sendo criado, mas o sistema n√£o conseguia localiz√°-lo no caminho especificado.

### 2. **Causa Raiz: Substitui√ß√£o de Vari√°veis no Procfile**

O problema estava relacionado ao uso de substitui√ß√£o de vari√°veis bash no arquivo `Procfile`:

```
web: node ${NEXT_DIST_DIR:-.next}/standalone/server.js
```

**Por que isso n√£o funciona?**
- O Heroku e Easypanel (baseado em Dokku) n√£o processam o Procfile atrav√©s de um shell bash
- O Procfile √© lido diretamente pelo gerenciador de processos
- A sintaxe `${NEXT_DIST_DIR:-.next}` √© uma funcionalidade do bash que **N√ÉO √© interpretada** pelo gerenciador de processos
- O sistema tentava literalmente executar: `node ${NEXT_DIST_DIR:-.next}/standalone/server.js` como um caminho literal

### 3. **Configura√ß√£o Desnecess√°ria no next.config.js**

A configura√ß√£o `distDir: process.env.NEXT_DIST_DIR || '.next'` era:
- Desnecess√°ria, pois o Next.js j√° usa `.next` como padr√£o
- Criava confus√£o e complexidade sem benef√≠cio
- Dependia de vari√°veis de ambiente que n√£o eram consistentemente definidas

### 4. **Script start no package.json**

O mesmo problema de substitui√ß√£o de vari√°veis existia no script `start`:
```json
"start": "node ${NEXT_DIST_DIR:-.next}/standalone/server.js"
```

---

## ‚úÖ Solu√ß√µes Implementadas

### 1. **Simplifica√ß√£o do next.config.js**

**Antes:**
```javascript
const nextConfig = {
  distDir: process.env.NEXT_DIST_DIR || '.next',
  output: 'standalone',
  // ... outras configura√ß√µes
};
```

**Depois:**
```javascript
const nextConfig = {
  output: 'standalone',
  // ... outras configura√ß√µes
};
```

**Benef√≠cios:**
- Usa o diret√≥rio padr√£o do Next.js (`.next`)
- Remove depend√™ncia de vari√°veis de ambiente
- Torna a configura√ß√£o mais simples e previs√≠vel

### 2. **Corre√ß√£o do Procfile**

**Antes:**
```
web: node ${NEXT_DIST_DIR:-.next}/standalone/server.js
```

**Depois:**
```
web: node .next/standalone/server.js
```

**Benef√≠cios:**
- Caminho absoluto e direto
- N√£o depende de interpreta√ß√£o de shell
- Funciona em qualquer plataforma de deployment (Heroku, Easypanel, Dokku)

### 3. **Corre√ß√£o do package.json**

**Antes:**
```json
"start": "node ${NEXT_DIST_DIR:-.next}/standalone/server.js"
```

**Depois:**
```json
"start": "node .next/standalone/server.js"
```

**Benef√≠cios:**
- Consist√™ncia com o Procfile
- Execu√ß√£o confi√°vel do servidor
- F√°cil de testar localmente

### 4. **Limpeza e Build Fresco**

Realizamos:
- Limpeza completa dos artefatos de build anteriores
- Build novo com as configura√ß√µes corrigidas
- Verifica√ß√£o da cria√ß√£o do arquivo `server.js`
- C√≥pia dos arquivos est√°ticos necess√°rios
- Teste local do servidor

---

## üîç Entendendo o Output Standalone do Next.js

O modo `output: 'standalone'` do Next.js cria uma build otimizada para deployment em containers:

### Estrutura Criada:
```
.next/
‚îú‚îÄ‚îÄ standalone/
‚îÇ   ‚îú‚îÄ‚îÄ server.js          # Servidor Node.js independente
‚îÇ   ‚îú‚îÄ‚îÄ package.json       # Depend√™ncias m√≠nimas
‚îÇ   ‚îú‚îÄ‚îÄ node_modules/      # Apenas depend√™ncias necess√°rias
‚îÇ   ‚îî‚îÄ‚îÄ .next/             # Arquivos de build internos
‚îî‚îÄ‚îÄ static/                # Assets est√°ticos (CSS, JS)
```

### Arquivos Necess√°rios para Deployment:
1. **`.next/standalone/`** - Cont√©m o servidor e depend√™ncias
2. **`.next/static/`** - Deve ser copiado para `.next/standalone/.next/static/`
3. **`public/`** - Deve ser copiado para `.next/standalone/public/`

**Importante:** Esses arquivos s√£o copiados automaticamente durante o build.

---

## üß™ Testes Realizados

### 1. Verifica√ß√£o do Arquivo server.js
```bash
ls -la .next/standalone/server.js
# ‚úÖ -rw-r--r-- 1 ubuntu ubuntu 4619 Oct 27 04:36 .next/standalone/server.js
```

### 2. Teste Local do Servidor
```bash
PORT=3001 node .next/standalone/server.js
# ‚úÖ ‚ñ≤ Next.js 14.2.28
# ‚úÖ  - Local: http://localhost:3001
# ‚úÖ  ‚úì Ready in 315ms
```

**Resultado:** Servidor inicia corretamente e responde √†s requisi√ß√µes.

---

## üìö Por Que Essas Mudan√ßas Funcionam?

### 1. **Procfile √© Interpretado Literalmente**
O gerenciador de processos (como foreman, Heroku, Dokku) l√™ o Procfile linha por linha e executa os comandos **exatamente como escritos**. N√£o h√° interpreta√ß√£o de shell, ent√£o:
- ‚ùå `${VAR}` n√£o √© substitu√≠do
- ‚ùå `$(command)` n√£o √© executado
- ‚úÖ Apenas caminhos literais funcionam

### 2. **Consist√™ncia Entre Ambientes**
Usar caminhos diretos garante que:
- O desenvolvimento local use o mesmo caminho
- O CI/CD use o mesmo caminho
- A produ√ß√£o use o mesmo caminho
- N√£o h√° surpresas com vari√°veis de ambiente

### 3. **Simplicidade e Manutenibilidade**
- Menos vari√°veis de ambiente para gerenciar
- Menos pontos de falha
- Mais f√°cil de debugar
- Mais f√°cil de documentar

---

## üöÄ Processo de Deploy no Easypanel

### Fluxo de Deploy:
1. **Build Phase:**
   - `npm install` - Instala depend√™ncias
   - `npm run build` - Executa `prisma generate && next build`
   - Next.js cria `.next/standalone/` com tudo necess√°rio

2. **Release Phase:**
   - Plataforma copia arquivos para `/workspace/`
   - Estrutura final: `/workspace/.next/standalone/server.js`

3. **Runtime Phase:**
   - Procfile √© lido: `web: node .next/standalone/server.js`
   - Servidor √© iniciado
   - Aplica√ß√£o fica dispon√≠vel

### Por que Falhava Antes:
```
Procfile: web: node ${NEXT_DIST_DIR:-.next}/standalone/server.js
                         ‚Üì
Sistema tentava: node ${NEXT_DIST_DIR:-.next}/standalone/server.js
                         ‚Üì
Caminho literal n√£o existente! ‚ùå
```

### Por que Funciona Agora:
```
Procfile: web: node .next/standalone/server.js
                    ‚Üì
Sistema executa: node .next/standalone/server.js
                    ‚Üì
Arquivo existe no caminho! ‚úÖ
```

---

## üìã Checklist de Verifica√ß√£o

Antes de fazer deploy, verifique:

- [ ] ‚úÖ `next.config.js` N√ÉO tem configura√ß√£o `distDir`
- [ ] ‚úÖ `Procfile` usa caminho direto: `web: node .next/standalone/server.js`
- [ ] ‚úÖ `package.json` script start usa: `"start": "node .next/standalone/server.js"`
- [ ] ‚úÖ Build local completa com sucesso
- [ ] ‚úÖ Arquivo `.next/standalone/server.js` existe ap√≥s build
- [ ] ‚úÖ Servidor inicia localmente sem erros
- [ ] ‚úÖ Vari√°veis de ambiente necess√°rias est√£o configuradas no Easypanel

---

## üîê Vari√°veis de Ambiente Necess√°rias

Configure no Easypanel:

### Essenciais:
```bash
DATABASE_URL=postgresql://user:password@host:5432/database
NEXTAUTH_URL=https://seu-dominio.com
NEXTAUTH_SECRET=seu-secret-aqui
```

### AWS (se usar S3):
```bash
AWS_ACCESS_KEY_ID=sua-key
AWS_SECRET_ACCESS_KEY=seu-secret
AWS_REGION=us-east-1
AWS_S3_BUCKET=seu-bucket
```

### Outras:
```bash
NODE_ENV=production
PORT=3000
```

---

## üéØ Pr√≥ximos Passos para Deploy

### 1. **Verificar Configura√ß√µes no Easypanel**

#### a) Build Settings:
- **Build Command:** `npm run build`
- **Install Command:** `npm install`
- **Node Version:** 20.x ou superior

#### b) Environment Variables:
Configure todas as vari√°veis listadas acima.

#### c) Port Configuration:
- **Port:** 3000 (ou deixe autom√°tico)
- O Easypanel detectar√° automaticamente do Procfile

### 2. **Conectar ao GitHub**
- Repository: `https://github.com/antoniogsouzaag/producoes.agmusic`
- Branch: `master`
- Auto-deploy: ‚úÖ Habilitado (recomendado)

### 3. **Configurar Database**
- Certifique-se que o banco PostgreSQL est√° acess√≠vel
- Teste a conex√£o com `DATABASE_URL`
- Execute migrations: `npx prisma migrate deploy`

### 4. **Deploy**
- Fa√ßa push para GitHub
- Easypanel detectar√° automaticamente
- Aguarde o build completar
- Verifique os logs

### 5. **Verifica√ß√£o P√≥s-Deploy**
```bash
# Verifique se a aplica√ß√£o est√° rodando
curl https://seu-dominio.com

# Verifique os logs
# (No painel do Easypanel)
```

---

## üêõ Troubleshooting

### Se o erro "Cannot find module" persistir:

1. **Verifique o Procfile:**
   ```bash
   cat Procfile
   # Deve mostrar: web: node .next/standalone/server.js
   ```

2. **Verifique os logs de build:**
   - Procure por "Creating an optimized production build"
   - Verifique se n√£o h√° erros durante `next build`

3. **Verifique a estrutura de arquivos:**
   ```bash
   ls -la .next/standalone/
   # Deve listar: server.js, package.json, node_modules/
   ```

4. **Teste localmente:**
   ```bash
   npm run build
   npm start
   ```

### Se o build falhar:

1. **Verifique as depend√™ncias:**
   ```bash
   npm install
   ```

2. **Verifique o banco de dados:**
   ```bash
   npx prisma generate
   npx prisma migrate deploy
   ```

3. **Limpe o cache:**
   ```bash
   rm -rf .next node_modules/.cache
   npm run build
   ```

---

## üìñ Refer√™ncias

### Documenta√ß√£o Oficial:
- [Next.js Standalone Output](https://nextjs.org/docs/pages/api-reference/next-config-js/output)
- [Next.js Deployment](https://nextjs.org/docs/deployment)
- [Heroku Node.js Support](https://devcenter.heroku.com/articles/nodejs-support)

### Heroku Procfile:
- [Process Types and Procfile](https://devcenter.heroku.com/articles/procfile)
- **Importante:** O Procfile N√ÉO suporta substitui√ß√£o de vari√°veis bash

---

## üìù Resumo das Mudan√ßas

| Arquivo | Antes | Depois |
|---------|-------|--------|
| **next.config.js** | `distDir: process.env.NEXT_DIST_DIR \|\| '.next'` | (removido) |
| **Procfile** | `web: node ${NEXT_DIST_DIR:-.next}/standalone/server.js` | `web: node .next/standalone/server.js` |
| **package.json** | `"start": "node ${NEXT_DIST_DIR:-.next}/standalone/server.js"` | `"start": "node .next/standalone/server.js"` |

---

## ‚ú® Conclus√£o

As mudan√ßas implementadas resolvem definitivamente o problema de deployment ao:

1. ‚úÖ **Eliminar depend√™ncia de vari√°veis de ambiente** desnecess√°rias
2. ‚úÖ **Usar caminhos diretos** que funcionam em todas as plataformas
3. ‚úÖ **Simplificar a configura√ß√£o** para facilitar manuten√ß√£o
4. ‚úÖ **Garantir consist√™ncia** entre ambientes
5. ‚úÖ **Seguir as melhores pr√°ticas** do Next.js e Heroku/Dokku

O deploy agora deve funcionar corretamente no Easypanel! üéâ

---

## üìû Suporte

Se tiver problemas ap√≥s estas mudan√ßas:

1. Verifique este documento completamente
2. Revise os logs de deploy no Easypanel
3. Confirme que todas as vari√°veis de ambiente est√£o configuradas
4. Teste localmente antes de fazer deploy

**Data da Corre√ß√£o:** 27 de Outubro de 2025  
**Vers√£o:** 1.0.0
